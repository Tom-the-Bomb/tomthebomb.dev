---
import { Image } from "astro:assets";

import BaseLayout from "../../layouts/BaseLayout.astro";
import Icon from "../../components/Icon.astro";
import HoverSlide from "../../components/HoverSlide.astro";
import { getAlbumImages } from "../../utils";
import { albums } from "../photography.astro";

export async function getStaticPaths() {
    return Object.values(albums).map((album) => (
        {
            params: {
                id: album.id,
            },
            props: {
                album,
            },
        }
    ));
}

const { album } = Astro.props;
const images = await getAlbumImages(album.id);

const title = album.data.title;
const alt = `An image from the album: [${title}]`;
---
<BaseLayout>
    <div id="album-page" class="flex flex-col flex-wrap gap-3 text-center mt-0 lg:mt-20 justify-center items-center">
        <div>
            <h1 class="text-4xl font-extrabold drop-shadow-lg">
                {title}
            </h1>
            <p class="font-zh text-2xl text-slate-100 p-1">{album.data.short_description}</p>
        </div>
        <p class="w-4/5 lg:w-1/2 pb-0 lg:pb-5 text-md opacity-75 font-sans">
            {album.data.description}
        </p>
        <p>
            <strong class="text-slate-200 drop-shadow-md font-semibold">
                {images.length} Photos
            </strong>
        </p>
        <div class="px-2 sm:px-0 mx-auto container my-8 sm:columns-2 md:columns-3 lg:columns-4 xl:columns-4">
            {
                images.map((image) => (
                    <Image
                        src={image}
                        alt={alt}
                        widths={[600]}
                        quality={80}
                        class={
                            `shadow-md mb-4 hover:scale-[102%] opacity-90
                            border-8 border-white transition-all duration-300 ease-in-out`
                        }
                        layout="constrained"
                        loading="lazy"
                        decoding="async"
                        data-album-image
                    />
                ))
            }
        </div>
        <div class="text-slate-200 drop-shadow-md font-semibold mt-0 lg:mt-10">
            <HoverSlide text="View More Albums â†’" href="/photography"/>
        </div>
    </div>
    <div
        id="modal"
        class="hidden fixed z-50 left-0 top-0 w-dvw h-dvh
        bg-black/75 backdrop-blur-md"
    >
        <Icon
            img="close"
            target="_self"
            size="4em"
            styles="close-btn absolute z-50 top-4 right-4 text-slate-100"
        />
        <div class="w-full h-full overflow-x-hidden">
            <div class="w-full h-full p-5 flex flex-col gap-3 justify-center items-center">
                <div id="modal-container"class="flex justify-center items-center grow min-h-0"></div>
                <p id="modal-caption" class="caption text-center font-sm font-sans text-slate-100 text-wrap"></p>
            </div>
        </div>
    </div>
    {
        images.map((slide, idx) => (
            <template id={`slide-${idx}`}>
                <Image
                    src={slide}
                    alt={alt}
                    widths={[1920]}
                    class="block max-h-full w-auto"
                    loading="lazy"
                    decoding="async"
                    data-full-image={slide.src}
                />
            </template>
        ))
    }
</BaseLayout>

<script>
    import { formatImageEXIF } from "../../utils";

    document.addEventListener('astro:page-load', () => {
        if (!document.getElementById('album-page')) {
            return;
        }

        const modal = document.getElementById('modal')!;
        const modalContainer = document.getElementById('modal-container')!;
        const caption = document.getElementById('modal-caption')!;

        document.querySelector('.close-btn')
            ?.addEventListener('click', (event) => {
                modalContainer.innerHTML = '';
                modal.style.display = 'none';
                event.stopPropagation();
            });

        document.querySelectorAll('[data-album-image]')
            ?.forEach((image, idx) => {
                image.addEventListener('click', async () => {
                    console.log(`Opening modal for image index: ${idx}`);
                    modal.style.display = 'block';
                    const modalTemplate = document.getElementById(`slide-${idx}`)! as HTMLTemplateElement;
                    const modalNode = modalTemplate.content.cloneNode(true);
                    modalContainer.appendChild(modalNode);

                    const img = modalContainer.querySelector<HTMLImageElement>('[data-full-image]')!;

                    if (!(img.complete && img.naturalWidth && img.naturalHeight)) {
                        await new Promise<void>((resolve) => {
                            img.addEventListener('load', () => resolve(), { once: true });
                            img.addEventListener('error', () => resolve(), { once: true });
                        });
                    }

                    caption.innerHTML = await formatImageEXIF(
                        img,
                        img.getAttribute('data-full-image')!,
                    );

                });
            });
    });
</script>