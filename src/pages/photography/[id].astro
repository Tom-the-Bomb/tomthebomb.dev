---
import { Image } from "astro:assets";

import BaseLayout from "../../layouts/BaseLayout.astro";
import Icon from "../../components/Icon.astro";
import HoverSlide from "../../components/HoverSlide.astro";
import { getAlbumImages } from "../../utils";
import { albums } from "../photography.astro";

export async function getStaticPaths() {
    return Object.values(albums).map((album) => (
        {
            params: {
                id: album.id,
            },
            props: {
                album,
            },
        }
    ));
}

const { album } = Astro.props;
const images = await getAlbumImages(album.id);

const title = album.data.title;
const alt = `An image from the album: [${title}]`;
---
<BaseLayout>
    <div id="album-page" class="flex flex-col flex-wrap gap-3 text-center mt-0 lg:mt-20 justify-center items-center">
        <div>
            <h1 class="text-4xl font-extrabold drop-shadow-lg">
                {title}
            </h1>
            <p class="font-zh text-2xl text-slate-100 p-1">{album.data.short_description}</p>
        </div>
        <p class="w-4/5 lg:w-1/2 pb-0 lg:pb-5 text-md opacity-75 font-sans">
            {album.data.description}
        </p>
        <p>
            <strong class="text-slate-200 drop-shadow-md font-semibold">
                {images.length} Photos
            </strong>
        </p>
        <div class="px-2 sm:px-0 mx-auto container my-8 perspective-[1000px] sm:columns-2 md:columns-3 lg:columns-4 xl:columns-4">
            {
                images.map((image) => (
                    <Image
                        src={image}
                        alt={alt}
                        widths={[650]}
                        quality={80}
                        format="webp"
                        class={
                            `translate-z-0 shadow-md mb-4 hover:scale-[102%]
                            border-8 border-white transition-all duration-300 ease-in-out`
                        }
                        layout="constrained"
                        loading="eager"
                        decoding="async"
                        data-album-image
                    />
                ))
            }
        </div>
        <div class="text-slate-200 drop-shadow-md font-semibold mt-0 lg:mt-10">
            <HoverSlide text="View More Albums â†’" href="/photography"/>
        </div>
    </div>
    <div
        id="modal"
        class="hidden fixed z-50 left-0 top-0 w-dvw h-dvh
        bg-black/75 backdrop-blur-md"
    >
        <Icon
            img="close"
            target="_self"
            size="4em"
            styles="close-btn absolute z-50 top-4 right-4 text-slate-100"
        />
        <div class="swiper-body w-full h-full overflow-x-hidden">
            <div class="swiper gallery-swiper w-full h-full">
                <div class="swiper-wrapper">
                    {
                        images.map(() => (
                            <div class="swiper-slide">
                                <div class="w-full h-full pt-10 p-5 flex flex-col gap-3 justify-center items-center">
                                    <div class="modal-container flex justify-center items-center grow min-h-0"></div>
                                    <p class="modal-caption text-center font-sm font-sans text-slate-100 text-wrap"></p>
                                    <div class="swiper-lazy-preloader"></div>
                                </div>
                            </div>
                        ))
                    }
                </div>
                <div class="z-50 swiper-pagination absolute top-0 left-1/2 h-10 text-sm/10 -translate-x-1/2 text-center font-monospace text-yellow-100"></div>
            </div>
        </div>
    </div>
    {
        images.map((image) => (
            <template>
                <Image
                    src={image}
                    alt={alt}
                    widths={[
                        image.width > image.height
                            ? 1400
                            : Math.round((image.width / image.height) * 1400),
                    ]}
                    quality={90}
                    format="webp"
                    class="block max-h-full w-auto"
                    loading="lazy"
                    decoding="async"
                    data-swiper-slide={image.src}
                />
            </template>
        ))
    }
</BaseLayout>

<script>
    import Swiper from 'swiper';
    import { Keyboard, EffectCoverflow, Pagination } from 'swiper/modules';

    import 'swiper/css';

    import { formatImageEXIF } from "../../utils";

    document.addEventListener('astro:page-load', () => {
        if (document.getElementById('album-page') == null) {
            return;
        }

        const modalEl = document.getElementById('modal')!;
        const slides = document.querySelectorAll('div.swiper-slide');
        const containers = document.querySelectorAll('div.modal-container');
        const captions = document.querySelectorAll('p.modal-caption');

        function renderSwiperImages() {
            document.querySelectorAll('template')
                ?.forEach(async (template, idx) => {
                    const modalContainer = containers[idx];
                    const modalNode = template.content.cloneNode(true);
                    modalContainer.appendChild(modalNode);

                    const img = modalContainer.querySelector('img')!;

                    if (!(img.complete && img.naturalWidth && img.naturalHeight)) {
                        await new Promise<void>((resolve) => {
                            img.addEventListener('load', () => resolve(), { once: true });
                            img.addEventListener('error', () => resolve(), { once: true });
                        });
                    }

                    captions[idx].innerHTML = await formatImageEXIF(
                        img,
                        img.getAttribute('data-swiper-slide')!,
                    );
                });
        }

        const swiper = new Swiper('.gallery-swiper', {
            modules: [Keyboard, EffectCoverflow, Pagination],
            effect: 'coverflow',
            loop: true,
            grabCursor: true,
            centeredSlides: true,
            keyboard: true,
            slidesPerView: 1,
            spaceBetween: 75,
            direction: 'vertical',
            breakpoints: {
                768: {
                    direction: 'horizontal',
                },
            },
            pagination: {
                el: '.swiper-pagination',
                type: 'fraction',
            },
        });

        modalEl.querySelector('.close-btn')
            ?.addEventListener('click', (event) => {
                modalEl.style.display = 'none';
                event.stopPropagation();
            });

        document.querySelectorAll('[data-album-image]')
            ?.forEach((image, idx) => {
                image.addEventListener('click', () => {
                    swiper.slideToLoop(
                        parseInt(
                            // I'm unsure why my `swiper` indices are not in order of rendering
                            slides[idx].getAttribute('data-swiper-slide-index')!,
                        ), 0
                    );
                    modalEl.style.display = 'block';

                    if (!containers[0].children.length) {
                        renderSwiperImages();
                    }
                });
            });

        (async () => {
            await Promise.all(Array.from(
                document.querySelectorAll('[data-album-image]')!
            )
                .map((img, idx) => {
                    const image = img as HTMLImageElement;

                    if (image.complete && image.naturalWidth && image.naturalHeight) {
                        return Promise.resolve();
                    }

                    return new Promise<void>((resolve) => {
                        image.addEventListener('load', () => resolve(), { once: true });
                        image.addEventListener('error', () => resolve(), { once: true });
                    });
                })
            );

            if (!containers[0].children.length) {
                renderSwiperImages();
            }
        })();
    });
</script>