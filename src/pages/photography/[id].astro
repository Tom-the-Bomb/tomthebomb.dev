---
import { Image } from "astro:assets";
import { getCollection } from "astro:content";

import BaseLayout from "../../layouts/BaseLayout.astro";
import Icon from "../../components/Icon.astro";
import { getAlbumImages } from "../../utils";

export async function getStaticPaths() {
    const albums = await getCollection("albums");

    return Object.values(albums).map((album) => (
        {
            params: {
                id: album.id,
            },
            props: {
                album,
            },
        }
    ));
}

const { album } = Astro.props;
const images = await getAlbumImages(album.id);

const title = album.data.title;
const alt = `An image from the album: [${title}]`;
---
<BaseLayout>
    <div class="flex flex-col flex-wrap gap-3 text-center">
        <h1 class="text-4xl font-extrabold drop-shadow-lg">
            {title}
        </h1>
        <p class="text-md opacity-75 font-sans">
            {album.data.description}
        </p>
        <div class="mx-auto container my-8 sm:columns-2 md:columns-3 lg:columns-4 xl:columns-5">
            {
                images.map((image, idx) => (
                    <Image
                        src={image}
                        alt={alt}
                        class={
                            `rounded-md mb-4 shadow-lg hover:scale-[102%] opacity-90
                            border border-transparent hover:border-slate-100
                            transition-all duration-300 ease-in-out`
                        }
                        format="avif"
                        quality={50}
                        loading="lazy"
                        decoding="async"
                        data-album-image
                    />
                ))
            }
        </div>
    </div>
    <div
        id="modal"
        class="hidden fixed z-50 left-0 top-0 w-screen h-screen
        bg-black bg-opacity-75 backdrop-blur-md"
    >
        <Icon
            img="close"
            target="_self"
            size="4em"
            styles="close-btn absolute right-0 z-50 m-4 mr-5 text-slate-100"
        />
        <div class="swiper-body w-full h-full overflow-x-hidden">
            <div class="swiper w-full h-full">
                <div id="swiper-container" class="swiper-wrapper">
                    {
                        images.map((slide) => (
                            <div class="swiper-slide">
                                <Image
                                    src={slide}
                                    alt={alt}
                                    class="abs-center max-h-full w-auto p-5 pb-12"
                                    format="avif"
                                    loading="lazy"
                                    decoding="async"
                                    data-swiper-slide={slide.src}
                                />
                                <p class="caption font-sm font-sans text-rose-100 absolute bottom-0 pb-3 text-center w-full text-wrap"></p>
                            </div>
                        ))
                    }
                </div>
                <div class="swiper-button-prev ml-10"></div>
                <div class="swiper-button-next mr-10"></div>
            </div>
        </div>
    </div>
</BaseLayout>

<script>
    import Swiper from 'swiper';
    import { Keyboard, Navigation, EffectCoverflow } from 'swiper/modules';

    import 'swiper/css';
    import 'swiper/css/navigation';

    import { formatImageEXIF } from "../../utils";

    var swiper: Swiper;

    document.addEventListener('DOMContentLoaded', () => {
        swiper = new Swiper('.swiper', {
            modules: [Keyboard, Navigation, EffectCoverflow],
            direction: 'horizontal',
            effect: 'coverflow',
            grabCursor: true,
            centeredSlides: true,
            loop: true,
            slidesPerView: 1,
            spaceBetween: 75,
            keyboard: {
                enabled: true,
            },
            navigation: {
                nextEl: '.swiper-button-next',
                prevEl: '.swiper-button-prev',
            },
        });
    });

    const modal = document.getElementById('modal')!;

    modal.querySelectorAll('div.swiper-slide')
        ?.forEach(async (slide) => {
            const img = slide.querySelector('img')!;

            slide.querySelector('p.caption')!.innerHTML = await formatImageEXIF(
                img,
                img.getAttribute('data-swiper-slide')!,
            );
        });

    modal.querySelector('.close-btn')
        ?.addEventListener('click', (event) => {
            modal.style.display = 'none';
            event.stopPropagation();
        });

    document.querySelectorAll('[data-album-image]')
        ?.forEach((image, idx) => {
            image.addEventListener('click', () => {
                swiper.slideReset();
                swiper.slideTo(idx);
                modal.style.display = 'block';
            });
        });
</script>